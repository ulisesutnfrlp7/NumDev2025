<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Precio vs m² — General</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
</head>
<body>
  <header class="header">
    <h1>ANÁLISIS NUMÉRICO - UNIDAD 8: AJUSTE POR MÉTODO DE MÍNIMOS CUADRADOS</h1>
    <nav class="nav">
      <a href="index.html" class="active">Inicio</a>
      <a href="barrioA.html">Barrio A</a>
      <a href="barrioB.html">Barrio B</a>
      <a href="barrioC.html">Barrio C</a>
      <a href="herramientas.html">Herramientas</a>
    </nav>
  </header>

  <main class="container">
    <div class="controls">
      <div>
        <button class="filter-btn active" data-barrio="All">Todos</button>
      </div>

      <div id="fits-controls" style="display:none;">
        <label><input type="checkbox" class="fit-toggle" data-fit="lineal" checked> Lineal <span class="r2-lineal">R²=--</span></label>
        <label><input type="checkbox" class="fit-toggle" data-fit="exponencial" checked> Exponencial <span class="r2-exponencial">R²=--</span></label>
        <label><input type="checkbox" class="fit-toggle" data-fit="potencial" checked> Potencial <span class="r2-potencial">R²=--</span></label>
        <label><input type="checkbox" class="fit-toggle" data-fit="cuadratico" checked> Cuadrático <span class="r2-cuadratico">R²=--</span></label>
      </div>

      <div style="margin-left:auto;">
        <button id="zoomIn">Acercar</button>
        <button id="zoomOut">Alejar</button>
        <button id="resetZoom">Reset</button>
        <button id="toggleTooltip">Toggle Tooltips</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <div class="chart-card">
        <canvas id="scatterChart" width="900" height="480"></canvas>
      </div>

      <aside class="info-card">
        <h3>Información</h3>
        <div class="fit-row"><div><span class="legend-swatch" style="background:#ff6384"></span> Barrio A</div></div>
        <div class="fit-row"><div><span class="legend-swatch" style="background:#36a2eb"></span> Barrio B</div></div>
        <div class="fit-row"><div><span class="legend-swatch" style="background:#4bc0c0"></span> Barrio C</div></div>
        <hr/>
      </aside>
    </div>

    <div style="margin-top:14px;">
      <small class="muted">
        Siempre hay que asegurarse de mantener el archivo <strong>datos.xlsx</strong> en la misma carpeta. 
        Columnas esperadas: <code>neighborhood</code>, <code>area_m2</code>, <code>price_kUSD</code>.
      </small>
    </div>

    <div class="footer">Proyecto — Visualización de Ajustes por Barrio (2025)</div>
  </main>

  <script src="js/graficos.js"></script>
  <script src="js/calculos.js"></script>
  <script>
    // Código principal de la página
    (async function(){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      let tooltipsEnabled = true;
      let currentBarrio = 'All';
      let visibleFits = { lineal:true, exponencial:true, potencial:true, cuadratico:true };

      const fitColors = {
        lineal: 'rgba(255,0,0,0.7)',
        exponencial: 'rgba(0,150,0,0.7)',
        potencial: 'rgba(0,0,200,0.7)',
        cuadratico: 'rgba(255,140,0,0.7)'
      };
      const barrioColors = {
        A: { bg: 'rgba(255,99,132,0.8)', border:'rgba(255,99,132,1)' },
        B: { bg: 'rgba(54,162,235,0.8)', border:'rgba(54,162,235,1)' },
        C: { bg: 'rgba(75,192,192,0.8)', border:'rgba(75,192,192,1)' }
      };

      // datasets base
      const baseDatasets = [
        { label:'Lineal', data:[], type:'line', borderColor:fitColors.lineal, borderWidth:3, fill:false, pointRadius:0, tension:0 },
        { label:'Exponencial', data:[], type:'line', borderColor:fitColors.exponencial, borderWidth:3, fill:false, pointRadius:0, tension:0 },
        { label:'Potencial', data:[], type:'line', borderColor:fitColors.potencial, borderWidth:3, fill:false, pointRadius:0, tension:0 },
        { label:'Cuadrático', data:[], type:'line', borderColor:fitColors.cuadratico, borderWidth:3, fill:false, pointRadius:0, tension:0 },
        { label:'Barrio A', data:[], backgroundColor:barrioColors.A.bg, borderColor:barrioColors.A.border, pointStyle:'cross', radius:7, borderWidth:2 },
        { label:'Barrio B', data:[], backgroundColor:barrioColors.B.bg, borderColor:barrioColors.B.border, pointStyle:'cross', radius:7, borderWidth:2 },
        { label:'Barrio C', data:[], backgroundColor:barrioColors.C.bg, borderColor:barrioColors.C.border, pointStyle:'cross', radius:7, borderWidth:2 }
      ];

      // creación del gráfico
      const scatterChart = new Chart(ctx, {
        type:'scatter',
        data:{ datasets: baseDatasets },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Precio vs m² por Barrio',
              color: '#f0f0f0',
              font: {
                size: 20,
                weight: 'bold',
                family: 'Segoe UI'
              }
            },
            legend: {
              position: 'top',
              labels: {
                color: '#f0f0f0',
                font: { size: 13, family: 'Segoe UI' },
                boxWidth: 14
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: '#222',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#00c896',
              borderWidth: 1,
              cornerRadius: 6,
              padding: 10,
              callbacks: {
                label: function(ctx) {
                  if (ctx.dataset.type === 'line') {
                    return `${ctx.dataset.label}: ${ctx.parsed.x} → ${ctx.parsed.y}`;
                  }
                  return `${ctx.dataset.label}: ${ctx.raw.x.toFixed(1)} m² → ${ctx.raw.y.toFixed(2)} kUSD`;
                }
              }
            },
            zoom: {
              pan: { enabled: true, mode: 'xy' },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'xy'
              }
            }
          },
          scales: {
            x: {
              min: 0,
              max: 150,
              title: {
                display: true,
                text: 'm²',
                color: '#f0f0f0',
                font: { size: 14 }
              },
              ticks: {
                color: '#f0f0f0',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255,255,255,0.08)' }
            },
            y: {
              min: 0,
              max: 400,
              title: {
                display: true,
                text: 'Precio (kUSD)',
                color: '#f0f0f0',
                font: { size: 14 }
              },
              ticks: {
                color: '#f0f0f0',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255,255,255,0.08)' }
            }
          }
        }
      }); // ✅ cierre correcto del Chart

      // Cargar datos
      const clusters = await DataLoader.loadXLSX('datos.xlsx');

      function actualizar(){
        scatterChart.data.datasets[4].data = (currentBarrio==='All' || currentBarrio==='A')? clusters.A : [];
        scatterChart.data.datasets[5].data = (currentBarrio==='All' || currentBarrio==='B')? clusters.B : [];
        scatterChart.data.datasets[6].data = (currentBarrio==='All' || currentBarrio==='C')? clusters.C : [];

        const dataForFits = currentBarrio==='All' ? [...clusters.A, ...clusters.B, ...clusters.C] : clusters[currentBarrio];
        if(dataForFits.length>0){
          const ajustes = Calculos.calcularAjustes(dataForFits);
          scatterChart.data.datasets[0].data = visibleFits.lineal && ajustes.lineal ? ajustes.lineal.points : [];
          scatterChart.data.datasets[1].data = visibleFits.exponencial && ajustes.exponencial ? ajustes.exponencial.points : [];
          scatterChart.data.datasets[2].data = visibleFits.potencial && ajustes.potencial ? ajustes.potencial.points : [];
          scatterChart.data.datasets[3].data = visibleFits.cuadratico && ajustes.cuadratico ? ajustes.cuadratico.points : [];

          // actualizar R²
          document.querySelector('.r2-lineal').textContent = ajustes.lineal ? `R²=${ajustes.lineal.r2.toFixed(4)}` : 'R²=N/A';
          document.querySelector('.r2-exponencial').textContent = ajustes.exponencial ? `R²=${ajustes.exponencial.r2.toFixed(4)}` : 'R²=N/A';
          document.querySelector('.r2-potencial').textContent = ajustes.potencial ? `R²=${ajustes.potencial.r2.toFixed(4)}` : 'R²=N/A';
          document.querySelector('.r2-cuadratico').textContent = ajustes.cuadratico ? `R²=${ajustes.cuadratico.r2.toFixed(4)}` : 'R²=N/A';
        } else {
          scatterChart.data.datasets[0].data = [];
          scatterChart.data.datasets[1].data = [];
          scatterChart.data.datasets[2].data = [];
          scatterChart.data.datasets[3].data = [];
        }
        scatterChart.update();
      }

      // Filtros UI
      document.querySelectorAll('.filter-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentBarrio = btn.dataset.barrio;
          document.getElementById('fits-controls').style.display = currentBarrio==='All' ? 'none' : 'inline-block';
          actualizar();
        });
      });

      document.querySelectorAll('.fit-toggle').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          visibleFits[cb.dataset.fit] = cb.checked;
          actualizar();
        });
      });

      document.getElementById('zoomIn').addEventListener('click', ()=> scatterChart.zoom(1.2));
      document.getElementById('zoomOut').addEventListener('click', ()=> scatterChart.zoom(0.8));
      document.getElementById('resetZoom').addEventListener('click', ()=> scatterChart.resetZoom());
      document.getElementById('toggleTooltip').addEventListener('click', ()=>{
        tooltipsEnabled = !tooltipsEnabled;
        scatterChart.options.plugins.tooltip.enabled = tooltipsEnabled;
        scatterChart.update();
      });

      // Inicial
      actualizar();
    })();
  </script>
</body>
</html>